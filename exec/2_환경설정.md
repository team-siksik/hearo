### Jenkins - docker-compose.yml
```yml
version: '3'
services:
  jenkins:
    container_name: my_jenkins
    image: jenkins/jenkins:lts
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker
      - /jenkins:/var/jenkins_home
    environment:
      - TZ=Asia/Seoul
    ports:
      - 8181:8080
    privileged: true
    user: root 
```

### Back - Dockerfile
```dockerfile
FROM gradle:jdk11 as builder

ENV APP_HOME=/apps

WORKDIR $APP_HOME

COPY build.gradle settings.gradle $APP_HOME/

COPY src $APP_HOME/src

RUN gradle clean build

FROM openjdk:11-jdk

ENV APP_HOME=/apps
ARG ARTIFACT_NAME=app.jar
ARG JAR_FILE_PATH=build/libs/hearo-0.0.1-SNAPSHOT.jar

WORKDIR $APP_HOME
COPY --from=builder $APP_HOME/$JAR_FILE_PATH $ARTIFACT_NAME

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

### Nginx - Dockerfile
```dockerfile
# build stage
FROM node:18 as build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# production stage
FROM nginx
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### AI- Dockerfile
```dockerfile
FROM tiangolo/uvicorn-gunicorn:python3.8

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        libgl1-mesa-glx \
        openssl\    
    && apt-get install libasound-dev libportaudio2 libportaudiocpp0 portaudio19-dev -y \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY ./requirements.txt ./requirements.txt

RUN pip install --no-cache-dir --upgrade -r ./requirements.txt

ENV GOOGLE_APPLICATION_CREDENTIALS=./credential.json

COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8090", "--ssl-keyfile", "/app/ssl_private_key.pem", "--ssl-certfile", "/app/ssl_certificate.pem"]
```

### Nginx - defalt.conf
```conf
upstream mybackend {
    server k8a603.p.ssafy.io:8080;
}

upstream myai {
    server k8a603.p.ssafy.io:8090;
}

server {
    listen 80;
    server_name k8a603.p.ssafy.io hear-o.co.kr;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name k8a603.p.ssafy.io hear-o.co.kr;
    ssl_certificate /etc/letsencrypt/live/k8a603.p.ssafy.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/k8a603.p.ssafy.io/privkey.pem;

    location /api/v1 {
        proxy_pass http://mybackend;
    }
    location /run {
        proxy_pass http://myai;
    }
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}
```

### docker-compose.yml
```yml
version: '3'
services:
    nginx:
        container_name: nginx
        image: hearo_nginx:1.0
        restart: unless-stopped
        volumes:
            - ./ssl/conf:/etc/nginx/conf.d
            - ./ssl/data/certbot/conf:/etc/letsencrypt
            - ./ssl/data/certbot/www:/var/www/certbot
            - /etc/localtime:/etc/localtime
        ports:
            - 80:80
            - 443:443
        depends_on:
            - spring_boot

    spring_boot:
        container_name: spring_boot
        image: hearo_backend:1.0
        volumes:
            - ./logs:/apps/logs
        environment:
            - TZ=${TZ}
        ports:
            - 8080:8080
        depends_on:
            - mysql

    mysql:
        container_name: hearo-mysql
        image: mysql:8.0.33
        volumes:
            - /home/ubuntu/db/mysql/data:/var/lib/mysql
        environment:
            - TZ=${TZ}
            - MYSQL_DATABASE=hearo
            - MYSQL_ROOT_PASSWORD=hearo
        command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
        ports:
            - 3306:3306
```

### mySQL 설정
```
# mysql docker 접속
docker exec -it hearo-mysql bash 
```
```
# 비밀번호 입력
mysql -u root -p
# 덤프 파일로 db 생성
source /root/hearo.sql
```

### 실행 방법
- 메인서버
  - k8a603.p.ssafy.io
```shell
cd backend/hearo
docker build -t hearo_backend:1.0 .
```
```shell
cd frontend/hearo_web
docker build -t hearo_nginx:1.0 .
```
```bash
docker-compose up -d
```

- 인공지능 서버
  - k8a6031.p.ssafy.io
```shell
echo "1. stop container"
docker stop hearo-fastapi

echo "2. remove container"
docker rm hearo-fastapi

echo "3. remove image"
docker rmi fastapi

echo "4. re-build image"
docker build -t fastapi /home/ubuntu/S08P31A603/backend/hearo_ai/.

echo "5. re-run container"
docker run -d -p 8090:8090 -v /home/ubuntu/tmp:/tmp --shm-size 2000000000 --name hearo-fastapi fastapi

echo "6. check!"
docker ps -a

echo "7. log!"
docker logs -f hearo-fastapi
```